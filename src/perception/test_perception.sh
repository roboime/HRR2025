#!/bin/bash

# Sistema de Teste e Conveni√™ncia - Percep√ß√£o RoboIME
# Suporte dual para c√¢meras CSI IMX219 e USB Logitech C930
# Jetson Orin Nano Super - Sistema YOLOv8 Simplificado (6 classes)

# Configurar ambiente com codifica√ß√£o UTF-8
export PYTHONIOENCODING=utf8
export LANG=C.UTF-8
export LC_ALL=C.UTF-8

# Adicionar caminhos de bibliotecas importantes
export PYTHONPATH="/usr/local/lib/python3.10/dist-packages:/usr/lib/python3/dist-packages:$PYTHONPATH"
export LD_LIBRARY_PATH="/usr/local/cuda-12.2/targets/aarch64-linux/lib:$LD_LIBRARY_PATH"

# Cores para mensagens
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configura√ß√µes
CONFIG_FILE="src/perception/config/perception_config.yaml"
USB_DEVICE="/dev/video0"

# Fun√ß√µes de utilit√°rios
function print_header() {
    echo -e "\n${BLUE}============================================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}============================================================${NC}\n"
}

function print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

function print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

function print_info() {
    echo -e "${YELLOW}üí° $1${NC}"
}

function print_warning() {
    echo -e "${PURPLE}‚ö†Ô∏è  $1${NC}"
}

function print_camera() {
    echo -e "${CYAN}üé• $1${NC}"
}

# Verificar se o script est√° sendo executado na raiz do workspace
SCRIPT_DIR=$(dirname "$0")
WORKSPACE_DIR=$(cd "$SCRIPT_DIR/../.." && pwd)

if [[ "$PWD" != "$WORKSPACE_DIR" ]]; then
    print_info "Mudando para o diret√≥rio raiz do workspace: $WORKSPACE_DIR"
    cd "$WORKSPACE_DIR"
fi

# Fun√ß√£o para verificar ambiente b√°sico
check_environment() {
    print_header "üîç Verificando Ambiente"

    # Verificar ROS 2
    if ! command -v ros2 &> /dev/null; then
        print_error "ROS 2 n√£o encontrado. Certifique-se de que o ROS 2 est√° instalado e configurado."
        return 1
    fi
    print_success "ROS 2 encontrado"

    # Verificar workspace
    if [ ! -f "./install/setup.bash" ]; then
        print_error "Arquivo setup.bash n√£o encontrado. Execute 'colcon build' primeiro."
        return 1
    fi
    print_success "Workspace encontrado"

    # Verificar pacote de percep√ß√£o
    if [ ! -d "./src/perception" ]; then
        print_error "Pacote 'perception' n√£o encontrado."
        return 1
    fi
    print_success "Pacote 'perception' encontrado"

    # Verificar se o pacote foi constru√≠do
    if [ ! -d "./install/perception" ]; then
        print_error "O pacote 'perception' n√£o foi constru√≠do. Execute 'colcon build --packages-select perception'."
        return 1
    fi
    print_success "Pacote 'perception' constru√≠do"

    # Configurar ambiente ROS
    print_info "Configurando ambiente ROS 2..."
    source ./install/setup.bash
    print_success "Ambiente ROS 2 configurado"

    return 0
}

# Fun√ß√£o para verificar depend√™ncias modernas
check_dependencies() {
    print_header "üì¶ Verificando Depend√™ncias Modernas"

    # Verificar PyTorch/Ultralytics (YOLOv8)
    echo "üîç Verificando YOLOv8/Ultralytics..."
    if python3 -c "import ultralytics; from ultralytics import YOLO; print(f'Ultralytics vers√£o: {ultralytics.__version__}')" 2>/dev/null; then
        print_success "YOLOv8/Ultralytics funcionando"
    else
        print_warning "YOLOv8/Ultralytics n√£o encontrado - detector YOLOv8 pode n√£o funcionar"
    fi

    # Verificar OpenCV moderno
    echo "üîç Verificando OpenCV..."
    if python3 -c "import cv2; print(f'OpenCV vers√£o: {cv2.__version__}')" 2>/dev/null; then
        print_success "OpenCV funcionando"
        
        # Verificar CUDA no OpenCV
        if python3 -c "import cv2; print(f'CUDA suportado: {cv2.cuda.getCudaEnabledDeviceCount() > 0}')" 2>/dev/null; then
            print_success "OpenCV com suporte CUDA"
        else
            print_warning "OpenCV sem suporte CUDA"
        fi
    else
        print_error "OpenCV n√£o encontrado"
        return 1
    fi

    # Verificar v4l-utils (para c√¢mera USB)
    if command -v v4l2-ctl &> /dev/null; then
        print_success "v4l-utils dispon√≠vel (suporte USB)"
    else
        print_warning "v4l-utils n√£o instalado (necess√°rio para c√¢mera USB)"
        print_info "Instale com: sudo apt install v4l-utils"
    fi

    return 0
}

# Fun√ß√£o para verificar c√¢meras dispon√≠veis
check_cameras() {
    print_header "üé• Verificando C√¢meras Dispon√≠veis"

    # Verificar CSI IMX219
    echo "1Ô∏è‚É£ Verificando CSI IMX219:"
    if dmesg | grep -q "imx219"; then
        print_success "   CSI IMX219 detectada"
    else
        print_warning "   CSI IMX219 n√£o detectada"
        print_info "   Verifique a conex√£o do cabo CSI"
    fi

    # Verificar USB
    echo "2Ô∏è‚É£ Verificando c√¢meras USB:"
    if lsusb | grep -q "Logitech"; then
        print_success "   C√¢mera Logitech detectada"
        lsusb | grep Logitech | sed 's/^/      /'
    else
        print_warning "   C√¢mera Logitech n√£o detectada"
    fi

    # Verificar dispositivos de v√≠deo
    echo "3Ô∏è‚É£ Verificando dispositivos de v√≠deo:"
    if ls /dev/video* &> /dev/null; then
        print_success "   Dispositivos de v√≠deo encontrados:"
        ls -la /dev/video* | sed 's/^/      /'
    else
        print_warning "   Nenhum dispositivo de v√≠deo encontrado"
    fi

    return 0
}

# Fun√ß√£o para teste espec√≠fico da c√¢mera C930
test_c930_camera() {
    print_header "üß™ Teste Espec√≠fico - C√¢mera USB Logitech C930"

    # Verifica√ß√£o b√°sica
    if [ ! -c "$USB_DEVICE" ]; then
        print_error "Dispositivo $USB_DEVICE n√£o encontrado"
        print_info "Verifique se a c√¢mera USB C930 est√° conectada"
        return 1
    fi

    if ! lsusb | grep -q "Logitech"; then
        print_error "C√¢mera Logitech n√£o detectada via lsusb"
        print_info "Verifique se a C930 est√° conectada corretamente"
        return 1
    fi

    print_success "C√¢mera C930 detectada"

    # Verificar capacidades (se v4l2-ctl dispon√≠vel)
    if command -v v4l2-ctl &> /dev/null; then
        print_info "Verificando capacidades da C930:"
        v4l2-ctl --device=$USB_DEVICE --info | head -5 | sed 's/^/   /'
        echo ""
        print_info "Formatos suportados:"
        v4l2-ctl --device=$USB_DEVICE --list-formats-ext | grep -E "(Index|Size|Interval)" | head -10 | sed 's/^/   /'
    else
        print_warning "v4l2-ctl n√£o dispon√≠vel - pulando verifica√ß√£o detalhada"
    fi

    # Teste OpenCV
    print_info "Testando captura OpenCV..."
    python3 << EOF
import cv2
import sys

try:
    print("   üîÑ Tentando abrir c√¢mera em $USB_DEVICE...")
    cap = cv2.VideoCapture('$USB_DEVICE', cv2.CAP_V4L2)
    
    if not cap.isOpened():
        print("   ‚ùå Falha ao abrir c√¢mera")
        sys.exit(1)
    
    # Configurar resolu√ß√£o C930
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)
    cap.set(cv2.CAP_PROP_FPS, 30)
    
    # Verificar configura√ß√µes
    width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
    fps = cap.get(cv2.CAP_PROP_FPS)
    
    print(f"   üìè Resolu√ß√£o: {width}x{height}")
    print(f"   üé¨ FPS: {fps}")
    
    # Testar captura
    ret, frame = cap.read()
    if ret:
        print(f"   ‚úÖ Frame capturado: {frame.shape}")
        print("   üéâ Teste OpenCV PASSOU!")
    else:
        print("   ‚ùå Falha na captura de frame")
        sys.exit(1)
    
    cap.release()
    
except Exception as e:
    print(f"   ‚ùå Erro: {e}")
    sys.exit(1)
EOF

    if [ $? -eq 0 ]; then
        print_success "Teste da c√¢mera C930 PASSOU"
        return 0
    else
        print_error "Teste da c√¢mera C930 FALHOU"
        return 1
    fi
}

# Fun√ß√£o para iniciar sistema com CSI
start_perception_csi() {
    print_header "üé• Iniciando Sistema com C√¢mera CSI IMX219"
    
    # Configurar para CSI
    if [ -f "$CONFIG_FILE" ]; then
        sed -i 's/camera_type: ".*"/camera_type: "csi"/' "$CONFIG_FILE"
        print_success "Configura√ß√£o alterada para CSI"
    else
        print_error "Arquivo de configura√ß√£o n√£o encontrado: $CONFIG_FILE"
        return 1
    fi

    print_camera "Configura√ß√µes CSI:"
    print_info "   üì∑ C√¢mera: CSI IMX219"
    print_info "   üìè Resolu√ß√£o: 640x480@30fps"
    print_info "   üéØ Detectores: YOLOv8 + Tradicionais"
    print_info "   ‚ö° Lat√™ncia: Baixa (~50ms)"
    echo ""

    # Iniciar sistema
    print_info "Iniciando sistema de percep√ß√£o com CSI..."
    ros2 launch perception dual_camera_perception.launch.py \
        camera_type:=csi \
        config_file:=$CONFIG_FILE \
        debug:=true
}

# Fun√ß√£o para iniciar sistema com USB
start_perception_usb() {
    print_header "üé• Iniciando Sistema com C√¢mera USB Logitech C930"
    
    # Verificar C930 primeiro
    if ! test_c930_camera; then
        print_error "Teste da C930 falhou - n√£o √© poss√≠vel iniciar sistema USB"
        return 1
    fi

    # Configurar para USB
    if [ -f "$CONFIG_FILE" ]; then
        sed -i 's/camera_type: ".*"/camera_type: "usb"/' "$CONFIG_FILE"
        print_success "Configura√ß√£o alterada para USB"
    else
        print_error "Arquivo de configura√ß√£o n√£o encontrado: $CONFIG_FILE"
        return 1
    fi

    print_camera "Configura√ß√µes USB C930:"
    print_info "   üì∑ C√¢mera: USB Logitech C930"
    print_info "   üìè Resolu√ß√£o: 1280x720@30fps"
    print_info "   üéØ Detectores: YOLOv8 + Tradicionais"
    print_info "   üîç Auto Focus: Ativo"
    print_info "   üìê Campo de Vis√£o: 90¬∞"
    echo ""

    # Iniciar sistema
    print_info "Iniciando sistema de percep√ß√£o com USB C930..."
    ros2 launch perception dual_camera_perception.launch.py \
        camera_type:=usb \
        config_file:=$CONFIG_FILE \
        debug:=true
}

# Fun√ß√£o para rebuildar workspace
rebuild_workspace() {
    print_header "üîß Reconstruindo Workspace"
    
    print_info "Reconstruindo pacote perception..."
    colcon build --packages-select perception

    if [ $? -eq 0 ]; then
        print_success "Workspace reconstru√≠do com sucesso"
        source ./install/setup.bash
        return 0
    else
        print_error "Falha ao reconstruir workspace"
        return 1
    fi
}

# Fun√ß√£o para informa√ß√µes do sistema
show_system_info() {
    print_header "üìä Informa√ß√µes e Status do Sistema"
    
    # Status ROS2
    echo "ü§ñ Status do ROS 2:"
    if ros2 node list &> /dev/null; then
        ros2 node list | sed 's/^/   /'
    else
        echo "   Nenhum n√≥ ROS em execu√ß√£o"
    fi
    echo ""

    # T√≥picos
    echo "üì° T√≥picos dispon√≠veis:"
    if ros2 topic list &> /dev/null; then
        ros2 topic list | grep -E "(camera|perception|image)" | sed 's/^/   /' || echo "   Nenhum t√≥pico de percep√ß√£o ativo"
    else
        echo "   Nenhum t√≥pico dispon√≠vel"
    fi
    echo ""

    # Configura√ß√£o atual da c√¢mera
    echo "üé• Configura√ß√£o atual da c√¢mera:"
    if [ -f "$CONFIG_FILE" ]; then
        current_camera=$(grep "camera_type:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')
        if [ "$current_camera" = "csi" ]; then
            echo "   üì∑ CSI IMX219 (640x480@30fps)"
        elif [ "$current_camera" = "usb" ]; then
            echo "   üì∑ USB Logitech C930 (1280x720@30fps)"
        else
            echo "   ‚ùì Configura√ß√£o desconhecida: $current_camera"
        fi
    else
        echo "   ‚ùå Arquivo de configura√ß√£o n√£o encontrado"
    fi
    echo ""

    # Vers√µes
    echo "üì¶ Vers√µes instaladas:"
    python3 -c "import cv2; print(f'   OpenCV: {cv2.__version__}')" 2>/dev/null || echo "   OpenCV: N√£o instalado"
    python3 -c "import ultralytics; print(f'   Ultralytics: {ultralytics.__version__}')" 2>/dev/null || echo "   Ultralytics: N√£o instalado"
    echo ""

    # Hardware
    echo "üñ•Ô∏è  Recursos de hardware:"
    echo "   CPUs: $(nproc)"
    echo "   Mem√≥ria: $(free -h | grep -i 'mem' | awk '{print $2}')"
    if command -v nvidia-smi &> /dev/null; then
        echo "   GPU: $(nvidia-smi --query-gpu=name --format=csv,noheader,nounits)"
    else
        echo "   GPU: N√£o dispon√≠vel"
    fi
}

# Menu principal
show_menu() {
    print_header "üöÄ Sistema de Teste e Conveni√™ncia - Percep√ß√£o RoboIME"
    echo "Sistema Simplificado: YOLOv8 (6 classes otimizadas - estrat√©gia + localiza√ß√£o)"
    echo "Suporte dual: CSI IMX219 e USB Logitech C930"
    echo ""
    echo "üìã MENU PRINCIPAL:"
    echo ""
    echo "üé• C√ÇMERAS:"
    echo "1. Iniciar sistema com CSI IMX219 (baixa lat√™ncia)"
    echo "2. Iniciar sistema com USB Logitech C930 (alta qualidade)"
    echo "3. Testar c√¢mera USB C930 (diagn√≥stico completo)"
    echo ""
    echo "üîß SISTEMA:"
    echo "4. Verificar ambiente e depend√™ncias"
    echo "5. Verificar c√¢meras dispon√≠veis"
    echo "6. Reconstruir workspace"
    echo "7. Informa√ß√µes e status do sistema"
    echo ""
    echo "üß™ TESTES AVAN√áADOS:"
    echo "8. Testar apenas detectores YOLOv8"
    echo "9. Testar apenas detectores tradicionais"
    echo "10. Benchmark de performance"
    echo ""
    echo "0. Sair"
    echo ""
}

# Fun√ß√£o principal
main() {
    # Verifica√ß√£o inicial r√°pida
    if ! check_environment; then
        print_error "Falha na verifica√ß√£o do ambiente"
        exit 1
    fi

    while true; do
        show_menu
        read -p "Escolha uma op√ß√£o: " option

        case $option in
            1)
                start_perception_csi
                ;;
            2)
                start_perception_usb
                ;;
            3)
                test_c930_camera
                ;;
            4)
                check_environment
                check_dependencies
                ;;
            5)
                check_cameras
                ;;
            6)
                rebuild_workspace
                ;;
            7)
                show_system_info
                ;;
            8)
                print_header "üß™ Testando apenas detectores YOLOv8"
                print_info "Iniciando sistema apenas com YOLOv8..."
                ros2 launch perception dual_camera_perception.launch.py \
                    config_file:=$CONFIG_FILE \
                    debug:=true
                ;;
            9)
                print_header "üß™ Testando apenas detectores tradicionais"
                print_info "Este teste requer configura√ß√£o manual no YAML"
                print_info "Desative YOLOv8 no arquivo de configura√ß√£o"
                ;;
            10)
                print_header "üìä Benchmark de Performance"
                print_info "Executando testes de benchmark..."
                
                echo "üîÑ Teste 1: Sistema CSI (10 segundos)"
                timeout 10 ros2 launch perception dual_camera_perception.launch.py \
                    camera_type:=csi config_file:=$CONFIG_FILE debug:=false &
                wait
                
                echo "üîÑ Teste 2: Sistema USB (10 segundos)"
                timeout 10 ros2 launch perception dual_camera_perception.launch.py \
                    camera_type:=usb config_file:=$CONFIG_FILE debug:=false &
                wait
                
                print_success "Benchmark conclu√≠do!"
                ;;
            0)
                print_info "Saindo do sistema de teste..."
                exit 0
                ;;
            *)
                print_error "Op√ß√£o inv√°lida! Tente novamente."
                sleep 2
                ;;
        esac

        echo ""
        read -p "Pressione ENTER para voltar ao menu..." 
    done
}

# Executar fun√ß√£o principal
main 